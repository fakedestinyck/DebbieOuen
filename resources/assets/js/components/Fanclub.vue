<template>
    <div>
        <section class="menu cid-s7hqhwhqJr" once="menu" id="menu1-4" data-rv-view="56">


            <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top navbar-toggleable-sm">
                <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                        data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <div class="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
                <div class="menu-logo">
                    <div class="navbar-brand">

                <span class="navbar-caption-wrap"><a class="navbar-caption text-white display-4"
                                                     href="/fc">
                        蒋申FanClub</a></span>
                    </div>
                </div>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true">
                        <li class="nav-item">
                            <a class="nav-link link text-white display-4" href="/">
                                <span class="mbri-home mbr-iconfont mbr-iconfont-btn"></span>
                                主页</a>
                        </li>
<!--                        <li class="nav-item dropdown open">-->
<!--                            <a class="nav-link link text-white display-4" href="https://mobirise.com"-->
<!--                               aria-expanded="true">-->
<!--                                <span class="mbri-search mbr-iconfont mbr-iconfont-btn"></span>-->
<!--                                About Us-->
<!--                            </a>-->
<!--                        </li>-->
                    </ul>
                    <div class="navbar-buttons mbr-section-btn"><a class="btn btn-sm btn-primary display-4"
                                                                   href="javascript:alert('施工中')"><span
                            class="mbri-user mbr-iconfont mbr-iconfont-btn">&nbsp;个人中心</span></a></div>
                </div>
            </nav>
        </section>

        <section class="engine"><a href="/fc">bootstrap button</a></section>
        <section class="cid-s7fZH8aHku mbr-fullscreen mbr-parallax-background" id="header2-0" data-rv-view="41">


            <div class="mbr-overlay" style="opacity: 0.3; background-color: rgb(118, 118, 118);"></div>

            <div class="container align-center">
                <div class="row justify-content-md-center">
                    <div class="mbr-white col-md-10">
                        <h1 class="mbr-section-title mbr-bold pb-3 mbr-fonts-style display-1">
                            蒋申粉丝俱乐部</h1>
                        <h3 class="mbr-section-subtitle align-center mbr-light pb-3 mbr-fonts-style display-2">
                            获取最新鲜的第一手资讯<br>尽在蒋申粉丝俱乐部</h3>


                    </div>
                </div>
            </div>
            <div class="mbr-arrow hidden-sm-down" aria-hidden="true">
                <a href="#next">
                    <i class="mbri-down mbr-iconfont"></i>
                </a>
            </div>
        </section>

        <section class="carousel slide cid-s7fZIOggm7" data-interval="false" id="slider1-1" data-rv-view="44">


            <div class="full-screen">
                <div class="mbr-slider slide carousel" data-pause="true" data-keyboard="false" data-ride="false"
                     data-interval="false">
                    <ol class="carousel-indicators">
                        <li data-app-prevent-settings="" data-target="#slider1-1" class=" active"
                            data-slide-to="0"></li>
<!--                        <li data-app-prevent-settings="" data-target="#slider1-1" data-slide-to="1"></li>-->
<!--                        <li data-app-prevent-settings="" data-target="#slider1-1" data-slide-to="2"></li>-->
                    </ol>
                    <div class="carousel-inner" role="listbox">
                        <div class="carousel-item slider-fullscreen-image active" data-bg-video-slide="false"
                             style="background-image: url(https://lg-bus1kzl6-1251693677.file.myqcloud.com/debbie/web/resource/bg_1.jpg);">
                            <div class="container container-slide">
                                <div class="image_wrapper">
                                    <div class="mbr-overlay"></div>
                                    <img src="https://lg-bus1kzl6-1251693677.file.myqcloud.com/debbie/web/resource/bg_1.jpg">
                                    <div class="carousel-caption justify-content-center">
                                        <div class="col-10 align-center"><h2 class="mbr-fonts-style display-1">信纸下载</h2>
                                            <p class="lead mbr-text mbr-fonts-style display-5">可选择是否需要包含粉丝铭牌的信纸</p>
                                            <div class="mbr-section-btn" buttons="0" v-loading="loading">
                                                <a class="btn btn-primary display-4" href="javascript:void(0)" @click="downloadLetterPaper(true)">带粉丝铭牌</a>
                                                <a class="btn  btn-white-outline display-4" href="javascript:void(0)" @click="downloadLetterPaper(false)">不带粉丝铭牌</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
<!--                        <div class="carousel-item slider-fullscreen-image"-->
<!--                             data-bg-video-slide="https://www.y.com/watch?v=fwkKc6M60-0">-->
<!--                            <div class="mbr-overlay"></div>-->
<!--                            <div class="container container-slide">-->
<!--                                <div class="image_wrapper"><img src="assets/images/2.jpg" style="opacity: 0;">-->
<!--                                    <div class="carousel-caption justify-content-center">-->
<!--                                        <div class="col-10 align-left"><h2 class="mbr-fonts-style display-1">VIDEO-->
<!--                                            SLIDE</h2>-->
<!--                                            <p class="lead mbr-text mbr-fonts-style display-5">Slide with youtube video-->
<!--                                                background and color overlay. Title and text are aligned to the-->
<!--                                                left.</p></div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="carousel-item slider-fullscreen-image" data-bg-video-slide="false"-->
<!--                             style="background-image: url(assets/images/3.jpg);">-->
<!--                            <div class="container container-slide">-->
<!--                                <div class="image_wrapper">-->
<!--                                    <div class="mbr-overlay"></div>-->
<!--                                    <img src="assets/images/3.jpg">-->
<!--                                    <div class="carousel-caption justify-content-center">-->
<!--                                        <div class="col-10 align-right"><h2 class="mbr-fonts-style display-1">IMAGE-->
<!--                                            SLIDE</h2>-->
<!--                                            <p class="lead mbr-text mbr-fonts-style display-5">Choose from the large-->
<!--                                                selection of latest pre-made blocks - jumbotrons, hero images, parallax-->
<!--                                                scrolling, video backgrounds, hamburger menu, sticky header and-->
<!--                                                more.</p>-->
<!--                                            <div class="mbr-section-btn" buttons="0"><a class="btn btn-info display-4"-->
<!--                                                                                        href="https://mobirise.com">FOR-->
<!--                                                WINDOWS</a> <a class="btn  btn-white-outline display-4"-->
<!--                                                               href="https://mobirise.com">FOR MAC</a></div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
                    </div>
                    <a data-app-prevent-settings="" class="carousel-control carousel-control-prev" role="button"
                       data-slide="prev" href="#slider1-1"><span aria-hidden="true"
                                                                 class="mbri-left mbr-iconfont"></span><span
                            class="sr-only">Previous</span></a><a data-app-prevent-settings=""
                                                                  class="carousel-control carousel-control-next"
                                                                  role="button" data-slide="next"
                                                                  href="#slider1-1"><span aria-hidden="true"
                                                                                          class="mbri-right mbr-iconfont"></span><span
                        class="sr-only">Next</span></a></div>
            </div>

        </section>
        <input name="animation" type="hidden">
    </div>
</template>

<script>
    import {axios} from "../axios/api";

    export default {
        name: "Fanclub",
        data() {
            return {
                inputUsername: '',
                inputPassword: '',
                loading: false,
                token: '',
                inputFid: '',
                csfi: false,
                fid: null,
                inputId: '',
                pic: '',
                downloadLetterPaperLoading: false,
            }
        },
        mounted() {
            if (!this.getCookies()) {
                return false;
            }
            this.hideLoading();
            this.complementJs();
        },
        computed: {
            formatedFid() {
                return (Array(4).join("0") + this.fid).slice(-4)
            }
        },
        methods: {
            complementJs() {
                $('.mbr-arrow').on('click', function (e) {
                    var $next = $(e.target).closest('section').next();
                    if ($next.hasClass('engine')) {
                        $next = $next.closest('section').next();
                    }
                    var offset = $next.offset();
                    $('html, body').stop().animate({
                        scrollTop: offset.top
                    }, 800, 'linear');
                });
            },
            hideLoading: function () {
                $('#loading_all').delay(500).hide(0);
                setTimeout(function () {
                    $('body').removeClass("scoll_dis");
                    document.removeEventListener("touchmove", myFunction);
                    $('html, body, main').css({
                        overflow: 'auto',
                        height: 'auto'
                    });
                }, 500);
                // console.log("hide");
            },
            getCookies() {
                if ($cookies.isKey('token') && $cookies.isKey('username') && $cookies.isKey('fid')) {
                    if ($cookies.get('token') !== '' && $cookies.get('username') !== '' && $cookies.get('fid') !== '') {
                        this.token = $cookies.get('token');
                        return true
                    }
                }
                this.$message({
                    type: 'error',
                    message: '请先登录！'
                });
                setTimeout(() => {
                    window.location.href="/";
                }, 2000);
                return false

            },
            doLogin() {
                this.loading = true;
                axios('/api/login', 'POST', {
                    email: this.inputUsername,
                    password: this.inputPassword
                })
                    .then((response) => {
                        if (response.data.token) {
                            let data = response.data;
                            this.token = data.token;
                            this.$message({
                                type: 'success',
                                message: '登陆成功'
                            });
                            if (data.csfi === 1) {
                                // 可以自定义粉丝编号
                                this.csfi = true
                            } else {
                                if (data.fid) {
                                    this.pic = `https://lg-bus1kzl6-1251693677.image.myqcloud.com/debbie/fc/badge/badge${data.fid}.jpg/small`
                                } else {
                                    // 不能自定义
                                    this.csfi = false
                                }
                            }
                        }

                    })
                    .catch((error) => {
                        if (error.code === 406) {
                            this.$message({
                                type: 'error',
                                message: error.data
                            })
                        } else {
                            if (error.code === 414) {
                                this.$message({
                                    type: 'error',
                                    message: error.data
                                })
                            }
                        }
                    })
                    .then(() => {
                        this.loading = false;
                    })

            },
            getFansId() {
                this.loading = true;
                axios('/api/fc/getfid', 'GET', {}, this.token)
                    .then((response) => {
                        if (response.data.fid) {
                            let data = response.data;
                            this.$message({
                                type: 'success',
                                message: `成功！你的粉丝编号为：${data.fid}`
                            });
                            this.fid = data.fid
                        }

                    })
                    .catch((error) => {
                        this.$message({
                            type: 'error',
                            message: `[E${error.code}] ${error.data}`
                        })
                    })
                    .then(() => {
                        this.loading = false;
                    })
            },
            doSubmitInfo() {
                this.loading = true;
                axios('/api/fc/postinfo', 'POST', {
                    fans_id: this.inputFid,
                    username: this.inputId,
                }, this.token)
                    .then((response) => {
                        // console.log(response);
                        if (response.data.pic_url) {
                            let data = response.data;
                            this.$message({
                                type: 'success',
                                message: `成功！这是你的粉丝铭牌。可以直接保存或截图}`
                            });
                            this.pic = "https://" + data.pic_url + "/small"
                        }

                    })
                    .catch((error) => {
                        if (error.code) {
                            this.$message({
                                type: 'error',
                                message: `[E${error.code}]\n${error.data}`
                            })
                        } else {
                            let msg = [];
                            for (let key in error) {
                                let item = error[key];
                                item.forEach((each) => {
                                    msg.push(each);
                                })
                            }
                            this.$message({
                                type: 'error',
                                message: `[E422]\n${msg.join('\n')}`
                            })
                        }

                    })
                    .then(() => {
                        this.loading = false;
                    })
            },
            badgeError(error) {
                if (error.path[0].src !== '') {
                    // 重新生成
                }
            },
            downloadLetterPaper(withBadge) {
                this.loading = true;
                axios('/api/fc/getletterpaper','GET',null,this.token,{b: withBadge})
                .then((response) => {
                    this.loading = false;
                    // console.log(response);
                    if (response.data && response.data.type && response.data.type === 'download') {
                        this.downloadWithBlob(response.data.data)
                    } else {
                        // let url = webkitURL.createObjectURL(response);
                        // this.downloadWithBlob(url)
                    }
                })
                .catch((error) => {
                    // console.log(error);
                    if (error.code && error.data) {
                        this.$message({
                            type: 'error',
                            message: error.data
                        });
                        if (error.code === 412) {
                            setTimeout(() => {
                                window.location.href="/fc/register"
                            }, 1000);
                            return false
                        }
                        this.loading = false;
                    }
                })
                .then(() => {
                    // this.loading = false;
                })
            },
            downloadWithBlob(url) {
                var a = document.createElement('a');
                var filename = '信纸.txt';
                a.href = url;
                a.download = filename;
                a.target = "_blank";
                a.click();
                window.URL.revokeObjectURL(url);
            }
        }
    }
</script>

<style scoped>
    .form-center {
        width: 90%;
        max-width: 768px;
        margin: auto;
    }

    .form-badge {
        max-width: 500px;
        position: relative;
    }

    .badge-canvas {
        width: 100%;
    }

    .el-message__content {
        word-break: break-all;
        white-space: pre-wrap;
    }

    .mbri-user.mbr-iconfont.mbr-iconfont-btn {
        font-size: 1rem;
    }

    .mbri-user:before {
        font-size: 1.6rem;
        vertical-align: middle;
    }

</style>